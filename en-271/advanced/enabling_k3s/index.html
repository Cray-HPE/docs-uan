<!DOCTYPE html>
<html lang="en-271" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.101.0" />
    <meta name="description" content="">


    <link rel="icon" href="/docs-uan/images/favicon.png" type="image/png">

    <title> :: User Access Node (UAN)</title>

    
    <link href="/docs-uan/css/nucleus.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/fontawesome-all.min.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/hybrid.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/featherlight.min.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/perfect-scrollbar.min.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/auto-complete.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/atom-one-dark-reasonable.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/theme.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/tabs.css?1704164687" rel="stylesheet">
    <link href="/docs-uan/css/hugo-theme.css?1704164687" rel="stylesheet">
    
    <link href="/docs-uan/css/theme-green.css?1704164687" rel="stylesheet">
    
    

    <script src="/docs-uan/js/jquery-3.3.1.min.js?1704164687"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
    
  </head>
  <body class="" data-url="/docs-uan/en-271/advanced/enabling_k3s/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/docs-uan/en-271'>
<img src=/docs-uan/images/hpe_pri_wht_rev_rgb.png alt="HPE" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/docs-uan/js/lunr.min.js?1704164687"></script>
<script type="text/javascript" src="/docs-uan/js/auto-complete.js?1704164687"></script>
<script type="text/javascript">
    
        var baseurl = "\/docs-uan\/\/en-271";
    
</script>
<script type="text/javascript" src="/docs-uan/js/search.js?1704164687"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/installation_prereqs/" title="" class="dd-item
        
        
        
        ">
      <a href="/docs-uan/en-271/installation_prereqs/">
          installation prereqs
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/installation_prereqs/prepare_for_uan_product_installation/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/installation_prereqs/prepare_for_uan_product_installation/">
        Prepare for UAN Product Installation
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/installation_prereqs/configure_the_bmc_for_uans_with_ilo/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/installation_prereqs/configure_the_bmc_for_uans_with_ilo/">
        Configure the BMC for UANs with iLO
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/installation_prereqs/configure_the_bios_of_an_hpe_uan/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/installation_prereqs/configure_the_bios_of_an_hpe_uan/">
        Configure the BIOS of an HPE UAN
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/install/" title="" class="dd-item
        
        
        
        ">
      <a href="/docs-uan/en-271/install/">
          install
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/install/install_the_uan_product_stream/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/install/install_the_uan_product_stream/">
        Install or Upgrade UAN
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/operations/" title="" class="dd-item
        
        
        
        ">
      <a href="/docs-uan/en-271/operations/">
          operations
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/basic_uan_configuration/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/basic_uan_configuration/">
        Basic UAN Configuration
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/build_a_new_uan_image_using_the_cos_recipe/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/build_a_new_uan_image_using_the_cos_recipe/">
        Build a New UAN Image Using a COS Recipe
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/create_uan_boot_images/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/create_uan_boot_images/">
        Create UAN Boot Images
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/mount_a_new_file_system_on_an_uan/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/mount_a_new_file_system_on_an_uan/">
        Mount a New File System on a UAN
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/configure_interfaces_on_uans/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/configure_interfaces_on_uans/">
        Configure Interfaces on UANs
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/configure_pluggable_authentication_modules_pam_on_uans/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/configure_pluggable_authentication_modules_pam_on_uans/">
        Configure Pluggable Authentication Modules (PAM) on UANs
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/boot_uans/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/boot_uans/">
        Boot UANs
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/cve-2023-0461/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/cve-2023-0461/">
        Mitigation for CVE-2023-0461
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_motd/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_motd/">
        `UAN motd`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_packages/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_packages/">
        `UAN packages`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_shadow/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_shadow/">
        `UAN shadow`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_interfaces/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_interfaces/">
        `UAN interfaces`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_ldap/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_ldap/">
        `UAN LDAP`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_gpg_keys/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_gpg_keys/">
        `UAN gpg keys`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_hardening/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_hardening/">
        `UAN hardening`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_ca_cert/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_ca_cert/">
        `UAN ca cert`
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/operations/uan_disk_config/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/operations/uan_disk_config/">
        `UAN disk config`
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/advanced/" title="" class="dd-item
        parent
        
        
        ">
      <a href="/docs-uan/en-271/advanced/">
          advanced
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/advanced/enabling_can_chn/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/advanced/enabling_can_chn/">
        Enabling the Customer Access Network (CAN) or the Customer High Speed Network (CHN)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/advanced/repurposing_compute_as_uan/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/advanced/repurposing_compute_as_uan/">
        Repurposing a Compute Node as a UAN
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/advanced/designating_application_nodes_for_k3s/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/advanced/designating_application_nodes_for_k3s/">
        Designating Application Nodes for K3s (Technical Preview)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/advanced/enabling_k3s/" title="" class="dd-item active">
        <a href="/docs-uan/en-271/advanced/enabling_k3s/">
        Configuring a UAN for K3s (Technical Preview)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/advanced/sles_image/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/advanced/sles_image/">
        Booting an Application Node with a SLE HPC Image (Technical Preview)
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/upgrade/" title="" class="dd-item
        
        
        
        ">
      <a href="/docs-uan/en-271/upgrade/">
          upgrade
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/upgrade/notable_changes/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/upgrade/notable_changes/">
        Notable Changes
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/upgrade/upgrades/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/upgrade/upgrades/">
        Upgrades
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/troubleshooting/" title="" class="dd-item
        
        
        
        ">
      <a href="/docs-uan/en-271/troubleshooting/">
          troubleshooting
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/troubleshooting/troubleshoot_uan_boot_issues/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/troubleshooting/troubleshoot_uan_boot_issues/">
        Troubleshoot UAN Boot Issues
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/troubleshooting/troubleshoot_uan_cfs_and_network_configuration_issues/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/troubleshooting/troubleshoot_uan_cfs_and_network_configuration_issues/">
        Troubleshoot UAN CFS and Network Configuration Issues
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/troubleshooting/troubleshoot_uan_disk_configuration_issues/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/troubleshooting/troubleshoot_uan_disk_configuration_issues/">
        Troubleshoot UAN Disk Configuration Issues
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/docs-uan/en-271/test-plan/" title="" class="dd-item
        
        
        
        ">
      <a href="/docs-uan/en-271/test-plan/">
          test-plan
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/docs-uan/en-271/test-plan/test-plan/" title="" class="dd-item ">
        <a href="/docs-uan/en-271/test-plan/test-plan/">
        Test Plan for User Access Node (UAN) and Repurposed Compute Node as UAN
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            
            Version: 
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en-271" value="/docs-uan/en-271/advanced/enabling_k3s/" selected>2.7.1</option>
                    
                  
              
                  
              
                  
              
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="en-270" value="/docs-uan/en-270/advanced/enabling_k3s/">2.7.0</option>
                    
                  
              
                  
              
                  
              
                  
              
          
              
              
                  
              
                  
              
                  
                    
                    
                      <option id="en-262" value="/docs-uan/en-262/advanced/enabling_k3s/">2.6.2</option>
                    
                  
              
                  
              
                  
              
          
              
              
                  
              
                  
              
                  
              
                  
                    
                    
                      <option id="en-261" value="/docs-uan/en-261/advanced/enabling_k3s/">2.6.1</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
              
                  
              
                  
              
                  
                    
                    
                      <option id="en-2511" value="/docs-uan/en-2511/advanced/enabling_k3s/">2.5.11</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      

      
      </ul>
    </section>
    
    <section id="footer">
      
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/docs-uan/en-271/'></a> > <a href='/docs-uan/en-271/advanced/'></a> > 
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#uai-experience-on-uans">UAI Experience on UANs</a>
      <ul>
        <li><a href="#use-of-k3s">Use of K3s</a></li>
        <li><a href="#use-of-podman">Use of Podman</a></li>
        <li><a href="#overview">Overview</a></li>
      </ul>
    </li>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#configuring-with-configuration-framework-service-cfs">Configuring with Configuration Framework Service (CFS)</a>
      <ul>
        <li><a href="#configuration-files-and-playbook">Configuration Files and Playbook</a></li>
        <li><a href="#ansible-roles">Ansible Roles</a></li>
        <li><a href="#artifactory-assets">Artifactory Assets</a></li>
        <li><a href="#validation-tests">Validation Tests</a></li>
      </ul>
    </li>
    <li><a href="#configuring-k3s-metallb-haproxy-and-sshd-for-use-with-podman">Configuring K3s, MetalLB, HAProxy, and SSHD for use with Podman</a>
      <ul>
        <li><a href="#metallb">MetalLB</a></li>
        <li><a href="#haproxy-configuration">HAProxy Configuration</a></li>
        <li><a href="#sshd-configuration">SSHD Configuration</a></li>
        <li><a href="#deploy-k3s-to-the-uan">Deploy K3s to the UAN</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#k3s-validation">K3s Validation</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              
            </h1>
          

        


<h1 id="configuring-a-uan-for-k3s-technical-preview">Configuring a UAN for K3s (Technical Preview)</h1>
<p><strong>WARNING</strong>: This feature is a Technical Preview, as such it requires completion of the <a href="#prerequisites">Prerequisites</a> section. Future releases will streamline these manual configuration steps and enhance the experience of using the rootless Podman containers. Therefore, some of these configuration options may change in future releases.</p>
<h2 id="uai-experience-on-uans">UAI Experience on UANs</h2>
<p>In HPE Cray Supercomputing UAN release 2.6, a new playbook has been added to create a single node, K3s cluster. This K3s environment can then run the services necessary to replicate the experience of User Access Instances (UAIs) on one or more UANs.</p>
<h3 id="use-of-k3s">Use of K3s</h3>
<p>K3s will serve as the orchestrator of services necessary to replicate the capabilities of UAIs on UAN hardware. These services include HAProxy, MetalLB, and eventually DNS services like ExternalDNS and PowerDNS. Notably, this does <strong>not</strong> orchestrate instances of <code>sshd</code> and <code>podman</code> containers through K3s. K3s and the initial set of services mimic how the &ldquo;Broker UAIs&rdquo; in CSM to handle the SSH ingress and redirection of users into their interactive environment.</p>
<h3 id="use-of-podman">Use of Podman</h3>
<p>Traditional UAIs in CSM required some level of privilege in CSM for access to host volume mounts, networking, and startup activities. Podman containers offer an attractive solution for an interactive environment in which to place users. They can be rootless containers that do not rely on privilege escalation. When running on UANs, Podman containers have access to a hosting environment that is already tailored to users.</p>
<h3 id="overview">Overview</h3>
<p>The overall component flow for replicating containerized environments for End-Users on UANs is as follows:</p>
<ol>
<li>A user uses <code>ssh</code> to initiate a connection to the HAProxy load-balancer running in K3s.</li>
<li>HAProxy, using the configured load balancing algorithms, will forward the SSH connection to an instance of <code>sshd</code> running on a UAN.</li>
<li><code>sshd</code>, running on a UAN through systemd, will initiate a rootless Podman container as the user using the <code>ForceCommand</code> configuration.</li>
<li>The user is placed in a Podman container for an interactive session, or their <code>SSH_ORIGINAL_COMMAND</code> is run in the container.</li>
<li>When the user disconnects, the Podman process exits, and the container is removed.</li>
</ol>
<p>There are alternate configurations of Podman that would allow for different workflows. For example, the main pid of the container could be long running, to facilitate easier re-entry to the container on subsequent logins.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>The following steps must be completed prior to configuring the UAN with K3s.</p>
<ol>
<li>
<p>Designate a UAN to operate as the K3s control-plane node. See <a href="/docs-uan/en-271/advanced/designating_application_nodes_for_k3s/">Designating Application Nodes for K3s</a>.</p>
</li>
<li>
<p>Identify a pool of IP addresses for the services running in K3s.</p>
</li>
</ol>
<p><strong>Note</strong>: The identification of a pool of IP addresses for the services running in K3s is best made at system installation time in order to avoid the possibility of IP collisions. If this is not possible, steps must be taken to ensure IP collisions are avoided.</p>
<p>This address pool must be routable from the UAN control-plane. It is suggested to split the <code>[CAN|CHN] Dynamic MetalLB</code> subnet into two subnets, <code>[CAN|CHN] Dynamic MetalLB</code> and <code>[CAN|CHN] Dynamic MetalLB K3s</code>, the latter being used for K3s services. Subnet definitions are initially uploaded to SLS at installation time by CSI. If the <code>[CAN|CHN] Dynamic MetalLB</code> subnet is split after initial installation, steps must be taken to ensure that IPs in the newly created <code>[CAN|CHN] Dynamic MetalLB K3s</code> subnet are not in use and the <code>MetalLB Controller</code> pod in CSM must be restarted. Alternatively, the starting and ending IPs for K3s may be defined directly in <code>vars/uan_helm.yml</code>.  These steps are described below.</p>
<p>Here is an example of splitting the existing <code>[CAN|CHN] Dynamic MetalLB</code> subnet. By default, the subnet with the <code>FullName</code> attribute of <code>[CAN|CHN] Dynamic MetalLB K3s</code> will be used for K3s, depending on whether <code>CAN</code> or <code>CHN</code> is being used for the customer access network.  This default <code>FullName</code> may be overridden by setting the <code>sls_can_metallb_fullname</code> variable in CFS to the expected name.</p>
<p><strong>Important</strong>: Before splitting <code>[CAN|CHN] Dynamic MetalLB</code>, be sure to verify none of the IP Addresses in the new <code>[CAN|CHN] Dynamic MetalLB K3s</code> subnet are being used. The <code>ims</code> and <code>user</code> namespaces are the most likely to contain these IPs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get services -n ims
</span></span><span style="display:flex;"><span>kubectl get services -n user
</span></span><span style="display:flex;"><span>kubectl get services -A
</span></span></code></pre></div><p>Edit SLS to make the following changes in the CAN or CHN network allocations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">### Existing [CAN|CHN] Dynamic MetalLB Subnet in SLS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Split this as shown below into two subnets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CIDR&#34;</span>: <span style="color:#e6db74">&#34;x.x.x.192/26&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;FullName&#34;</span>: <span style="color:#e6db74">&#34;CAN Dynamic MetalLB&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;x.x.x.193&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;MetalLBPoolName&#34;</span>: <span style="color:#e6db74">&#34;customer-access&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;can_metallb_address_pool&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;VlanID&#34;</span>: 6,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### New [CAN|CHN] Dynamic MetalLB Subnet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CIDR&#34;</span>: <span style="color:#e6db74">&#34;x.x.x.192/27&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;FullName&#34;</span>: <span style="color:#e6db74">&#34;CAN Dynamic MetalLB&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;x.x.x.193&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;MetalLBPoolName&#34;</span>: <span style="color:#e6db74">&#34;customer-access&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;can_metallb_address_pool&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;VlanID&#34;</span>: 6,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### New [CAN|CHN] Dynamic MetalLB K3s</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;CIDR&#34;</span>: <span style="color:#e6db74">&#34;x.x.x.224/27&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;FullName&#34;</span>: <span style="color:#e6db74">&#34;CAN Dynamic MetalLB K3s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Gateway&#34;</span>: <span style="color:#e6db74">&#34;x.x.x.225&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;MetalLBPoolName&#34;</span>: <span style="color:#e6db74">&#34;customer-access-k3s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;can_metallb_k3s_address_pool&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;VlanID&#34;</span>: 6,
</span></span></code></pre></div><p>Reallocate the CSM MetalLB pool <code>customer-access</code> from CSM to reflect the SLS changes above. To shrink the <code>customer-access</code> pool in CSM, edit the configmap and pick the new CIDR block for the <code>[CAN|CHN] Dynamic MetalLB</code> subnet in SLS. In this example the CIDR block was <code>x.x.x.193/26</code> and is now <code>x.x.x.193/27</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># kubectl edit -n metallb-system cm/metallb</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  config: |
</span></span><span style="display:flex;"><span>    address-pools:
</span></span><span style="display:flex;"><span>    - addresses:
</span></span><span style="display:flex;"><span>      - x.x.x.193/27
</span></span><span style="display:flex;"><span>      name: customer-access
</span></span><span style="display:flex;"><span>      protocol: bgp
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>To complete migrating the IP Address range out of CSM, restart the <code>MetalLB Controller</code> pod in CSM.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete pod -n metallb-system -l app.kubernetes.io/component<span style="color:#f92672">=</span>controller
</span></span></code></pre></div><p>Here&rsquo;s an example of defining the MetalLB IP pool range directly in <code>vars/uan_helm.yml</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">metallb_ipaddresspool_range_start</span>: <span style="color:#e6db74">&#34;&lt;start-of-range&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metallb_ipaddresspool_range_end</span>: <span style="color:#e6db74">&#34;&lt;end-of-range&gt;&#34;</span>
</span></span></code></pre></div><p>By default, these arguments are commented out or omitted. MetalLB will be
able to start, but the Custom Resource Definition for IPAddressPool and
L2AdvertisementAddress will not be created and no Load Balancer IP address
will be allocated.</p>
<p>This pool will allow for external <code>LoadBalancer</code> IP address to be assigned to services like <code>HAProxy</code>. Initially, these IP addresses will serve as the SSH ingress for instances of <code>HAProxy</code>.</p>
<ol>
<li>
<p>Configure and create the <code>/etc/subuid</code> and <code>/etc/subgid</code> files.</p>
<p>To allow for users to run rootless Podman containers, these files must be present and configured with an entry for each user. These files must be uploaded to the <code>user</code> S3 bucket:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cray artifacts list user --format json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;artifacts&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Key&#34;</span>: <span style="color:#e6db74">&#34;subuid&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;LastModified&#34;</span>: <span style="color:#e6db74">&#34;2023-02-21T23:41:43.948000+00:00&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;ETag&#34;</span>: <span style="color:#e6db74">&#34;\&#34;c543aebb9b40bcf48879885734447090\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;</span>Size<span style="color:#e6db74">&#34;: 145686,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;</span>StorageClass<span style="color:#e6db74">&#34;: &#34;</span>STANDARD<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;</span>Owner<span style="color:#e6db74">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;</span>DisplayName<span style="color:#e6db74">&#34;: &#34;</span>User Service User<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;</span>ID<span style="color:#e6db74">&#34;: &#34;</span>USER<span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;</span>Key<span style="color:#e6db74">&#34;: &#34;</span>subgid<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;</span>LastModified<span style="color:#e6db74">&#34;: &#34;</span>2023-02-21T23:41:43.948000+00:00<span style="color:#e6db74">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      &#34;</span>ETag<span style="color:#e6db74">&#34;: &#34;</span><span style="color:#ae81ff">\&#34;</span>73032ede132e44d2c1bc567246901737<span style="color:#ae81ff">\&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Size&#34;</span>: 145686,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;StorageClass&#34;</span>: <span style="color:#e6db74">&#34;STANDARD&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Owner&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;DisplayName&#34;</span>: <span style="color:#e6db74">&#34;User Service User&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ID&#34;</span>: <span style="color:#e6db74">&#34;USER&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>Place a Podman container image suitable for users within a container image registry accessible from the UAN.</p>
</li>
</ol>
<h2 id="configuring-with-configuration-framework-service-cfs">Configuring with Configuration Framework Service (CFS)</h2>
<p>After completing the <a href="#prerequisites">Prerequisites</a> section, the following are available to proceed with configuring a UAN to run K3s.</p>
<ul>
<li>A fully configured UAN</li>
<li>An IPAddress start and end range to assign to MetalLB</li>
<li>Prepared subuid and subgid files</li>
</ul>
<h3 id="configuration-files-and-playbook">Configuration Files and Playbook</h3>
<p>Configuration for K3s and related services are controlled in the following ansible files in the UAN VCS repository:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls uan-config-management/vars/ | egrep <span style="color:#e6db74">&#34;k3s|sshd|helm&#34;</span>
</span></span><span style="display:flex;"><span>uan_helm.yml
</span></span><span style="display:flex;"><span>uan_k3s.yml
</span></span><span style="display:flex;"><span>uan_sshd.yml
</span></span></code></pre></div><p>The ansible playbook to install and configure K3s may be found here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls uan-config-management | grep k3s
</span></span><span style="display:flex;"><span>k3s.yml
</span></span></code></pre></div><h3 id="ansible-roles">Ansible Roles</h3>
<p>The following Ansible roles are provided in the <code>uan-config-management</code> repository in VCS. There are <code>README.md</code> files in each Ansible role directory in this repository that provide further details.</p>
<ul>
<li><strong>uan-k3s-install</strong>: Download and stage K3s assets necessary to initialize and configure k3s on a node</li>
<li><strong>uan-k3s-stage</strong>: Install and configure K3s on a node</li>
<li><strong>uan-helm</strong>: Perform tasks to initialize an environment to install helm charts</li>
<li><strong>uan-haproxy</strong>: Deploy a list of HAProxy charts to the k3s cluster</li>
<li><strong>uan-metallb</strong>: Deploy the MetalLB chart to the k3s cluster</li>
<li><strong>uan-sshd</strong>: Create and enable instances of <code>sshd</code> with systemd</li>
<li><strong>uan-podman</strong>: Prepare node for rootless podman</li>
</ul>
<h3 id="artifactory-assets">Artifactory Assets</h3>
<p>UAN uploads artifacts to deploy to the UAN control-plane node in the nexus repository:</p>
<ul>
<li>uan-@product_version@-third-party</li>
</ul>
<p>The following Nexus group repository is created and references the previous UAN Nexus raw repos.</p>
<ul>
<li>uan-@product_version_short@-third-party</li>
</ul>
<p>This repository will contain the installer for K3s and Helm charts for HAProxy and MetalLB.</p>
<h3 id="validation-tests">Validation Tests</h3>
<p>To validate the K3s cluster after it is deployed, see the <a href="#validation-checks">Validation Checks</a> section of this document for details.</p>
<h2 id="configuring-k3s-metallb-haproxy-and-sshd-for-use-with-podman">Configuring K3s, MetalLB, HAProxy, and SSHD for use with Podman</h2>
<p>Each of the following sections describes how the various components deployed to K3s and the UANs may be configured to enable users to SSH to rootless Podman containers. As there is no one configuration to fit any one use case, read and understand each section to modify the configuration as needed. After each section has been completed, see <a href="#deploy-k3s-to-the-uan">Deploy K3s to the UAN</a>.</p>
<h3 id="metallb">MetalLB</h3>
<p>By default, <code>metallb_ipaddresspool_range_start</code> and <code>metallb_ipaddresspool_end</code> will be defined from the <code>[CAN|CHN] Dynamic MetalLB K3s</code> subnet in SLS, if it exists. Alternatively, they may be configured directly in <code>vars/uan_helm.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ grep <span style="color:#e6db74">&#34;^metallb_ipaddresspool&#34;</span> vars/uan_helm.yml
</span></span><span style="display:flex;"><span>metallb_ipaddresspool_range_start: <span style="color:#e6db74">&#34;x.x.x.x&#34;</span>
</span></span><span style="display:flex;"><span>metallb_ipaddresspool_range_end: <span style="color:#e6db74">&#34;x.x.x.x&#34;</span>
</span></span></code></pre></div><p>MetalLB will assign an IP address to each service running in K3s that requires and external IP address. For HAProxy, each instance of HAProxy will require an IP address. Podman containers do <em>not</em> require their own IP address.</p>
<h3 id="haproxy-configuration">HAProxy Configuration</h3>
<p>Each SSH ingress is backed by a K3s deployment of HAProxy. By default, a single instance of HAProxy is enabled in <code>vars/uan_helm.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">uan_haproxy</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;haproxy-uai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;haproxy-uai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#e6db74">&#34;{{ haproxy_chart }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart_path</span>: <span style="color:#e6db74">&#34;{{ helm_install_path }}/charts/{{ haproxy_chart }}.tgz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>: <span style="color:#e6db74">&#34;--set service.type=LoadBalancer&#34;</span>
</span></span></code></pre></div><p>This file must be further configured with additional values to populate the HAProxy configuration. For example, to load-balance SSH to three UANs, the following configuration changes must be made:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">uan_haproxy</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;haproxy-uai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">namespace</span>: <span style="color:#e6db74">&#34;haproxy-uai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart</span>: <span style="color:#e6db74">&#34;{{ haproxy_chart }}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chart_path</span>: <span style="color:#e6db74">&#34;{{ helm_install_path }}/charts/{{ haproxy_chart }}.tgz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">args</span>: <span style="color:#e6db74">&#34;--set service.type=LoadBalancer&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        log stdout format raw local0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        maxconn 1024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      defaults
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        log     global
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mode    tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        timeout connect 10s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        timeout client 36h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        timeout server 36h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        option  dontlognull
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      listen ssh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bind *:22
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        balance leastconn
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mode tcp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        option tcp-check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tcp-check expect rstring SSH-2.0-OpenSSH.*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        server uan01 uan01.example.domain.com:9000 check inter 10s fall 2 rise 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        server uan02 uan02.example.domain.com:9000 check inter 10s fall 2 rise 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        server uan03 uan03.example.domain.com:9000 check inter 10s fall 2 rise 1</span>      
</span></span></code></pre></div><p>This example that must be tailored to the wanted configuration. See the <a href="#sshd-configuration">SSHD Configuration</a> section to create new instances of SSHD to respond to HAProxy connections outside of the standard SSHD running on port 22.</p>
<p>For more information on HAProxy configurations, see <a href="https://docs.haproxy.org/2.7/configuration.html">HAProxy Configuration</a></p>
<p>To enable additional instances of HAProxy representing alternate configurations, add an element to the list <code>uan_haproxy</code>.</p>
<h3 id="sshd-configuration">SSHD Configuration</h3>
<p>The role <code>uan_sshd</code> runs in the playbook <code>k3s.yml</code> to start and configure new instances of SSHD to respond to HAProxy forwarded connections. Each new instance of SSHD is defined in <code>vars/uan_sshd.yml</code> as an element in the list <code>uan_sshd_configs</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">uan_sshd_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;uai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config_path</span>: <span style="color:#e6db74">&#34;/etc/ssh/uan&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#e6db74">&#34;9000&#34;</span>
</span></span></code></pre></div><p>This configuration will create a systemd unit file <code>/usr/lib/systemd/system/sshd_uai.service</code> and will mark the service as enabled. An SSH configuration file will also be created at <code>/etc/ssh/uan/sshd_uai_config</code> to start <code>sshd</code> listening on port 9000.</p>
<p>This default configuration will simply place users into their standard shell. To create a rootless Podman container upon logging in, specify an alternate configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;uai&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config_path</span>: <span style="color:#e6db74">&#34;/etc/ssh/uan&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#e6db74">&#34;9000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">config</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      Match User *
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        AcceptEnv DISPLAY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        X11Forwarding yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        AllowTcpForwarding yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        PermitTTY yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ForceCommand podman --root /scratch/containers/$USER run -it -h uai --cgroup-manager=cgroupfs --userns=keep-id --network=host -e DISPLAY=$DISPLAY registry.local/cray/uai:latest</span>      
</span></span></code></pre></div><p><strong>Note</strong>: In the example above, the image <code>registry.local/cray/uai:latest</code> was provided as an example, but this example must be modified to reference an available container image.</p>
<h3 id="deploy-k3s-to-the-uan">Deploy K3s to the UAN</h3>
<p>After the VCS repository has been updated with the appropriate values, generate a new image and reboot the UAN.</p>
<p>Alternatively, update the active CFS configuration on a single running UAN to include the <code>k3s.yml</code> playbook and uncomment out the following line from k3s.yml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Application node personalization play</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">include_role</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;{{ item }}&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#- uan_k3s_stage # Uncomment to stage K3s assets without Image Customization</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">uan_k3s_install</span>
</span></span></code></pre></div><p>This configuration will download the necessary assets without requiring an image rebuild.</p>
<p>After the node has been booted and configured, proceed with the <a href="#validation-checks">Validation Checks</a> section to verify the components have been configured correctly.</p>
<h1 id="validation-checks">Validation Checks</h1>
<h2 id="k3s-validation">K3s Validation</h2>
<p>To verify the <code>k3s.yml</code> playbook succeeded, perform the following verification checks.</p>
<ol>
<li>
<p>Verify <code>kubectl</code> from the UAN.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># export KUBECONFIG=~/.kube/k3s.yml</span>
</span></span><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME    STATUS   ROLES                  AGE     VERSION
</span></span><span style="display:flex;"><span>uan01   Ready    control-plane,master   3h58m   v1.26.0+k3s1
</span></span></code></pre></div></li>
<li>
<p>Verify HAProxy and MetalLB are installed with <code>helm</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># export KUBECONFIG=~/.kube/k3s.yml</span>
</span></span><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># helm ls -A</span>
</span></span><span style="display:flex;"><span>NAME       	NAMESPACE     	REVISION	UPDATED                                	STATUS  	CHART         	APP VERSION
</span></span><span style="display:flex;"><span>haproxy-uai	haproxy-uai   	<span style="color:#ae81ff">1</span>       	2023-03-01 10:55:10.916137137 -0600 CST	deployed	haproxy-1.17.3	2.6.6
</span></span><span style="display:flex;"><span>metallb    	metallb-system	<span style="color:#ae81ff">1</span>       	2023-03-01 10:40:15.548380973 -0600 CST	deployed	metallb-0.13.7	v0.13.7
</span></span></code></pre></div></li>
<li>
<p>Check pod status of HAProxy and MetalLB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># kubectl get pods -A | egrep &#34;haproxy|metallb&#34;</span>
</span></span><span style="display:flex;"><span>metallb-system   metallb-controller-5b89f7554c-mzjvt       1/1     Running   <span style="color:#ae81ff">0</span>          4h1m
</span></span><span style="display:flex;"><span>metallb-system   metallb-speaker-ltnkx                     1/1     Running   <span style="color:#ae81ff">0</span>          4h1m
</span></span><span style="display:flex;"><span>haproxy-uai      haproxy-uai-7kg6p                         1/1     Running   <span style="color:#ae81ff">0</span>          3h46m
</span></span></code></pre></div></li>
<li>
<p>Verify MetalLB has assigned an external IP address to HAProxy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># kubectl get services -A -l app.kubernetes.io/name=haproxy</span>
</span></span><span style="display:flex;"><span>NAMESPACE     NAME          TYPE           CLUSTER-IP     EXTERNAL-IP      PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>haproxy-uai   haproxy-uai   LoadBalancer   x.x.x.x        x.x.x.x          22:30886/TCP   3h47m
</span></span></code></pre></div></li>
<li>
<p>Verify that the new instance of SSHD is running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>uan01:~ <span style="color:#75715e"># systemctl status sshd_uai</span>
</span></span><span style="display:flex;"><span> sshd_uai.service - OpenSSH Daemon Generated <span style="color:#66d9ef">for</span> uai
</span></span><span style="display:flex;"><span>  Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/sshd_uai.service; disabled; vendor preset: disabled<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since Wed 2023-03-01 12:43:31 CST; 2h 4min ago
</span></span></code></pre></div></li>
<li>
<p>Finally, use SSH to log in through the HAProxy load balancer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ssh x.x.x.x
</span></span><span style="display:flex;"><span>Trying to pull registry.local/cray/uai:1.0...
</span></span><span style="display:flex;"><span>Getting image source signatures
</span></span><span style="display:flex;"><span>Copying blob 07a88a2f44f8 <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Copying blob 99a1d1c8ca98 <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Copying blob a028e278fdc1 <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Copying blob 5caad07f5e12 <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Copying blob 157b0fca679c <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Copying config de48e6a913 <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>Writing manifest to image destination
</span></span><span style="display:flex;"><span>Storing signatures
</span></span><span style="display:flex;"><span>sh-4.4$
</span></span></code></pre></div></li>
</ol>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/docs-uan/js/clipboard.min.js?1704164687"></script>
    <script src="/docs-uan/js/perfect-scrollbar.min.js?1704164687"></script>
    <script src="/docs-uan/js/perfect-scrollbar.jquery.min.js?1704164687"></script>
    <script src="/docs-uan/js/jquery.sticky.js?1704164687"></script>
    <script src="/docs-uan/js/featherlight.min.js?1704164687"></script>
    <script src="/docs-uan/js/highlight.pack.js?1704164687"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/docs-uan/js/modernizr.custom-3.6.0.js?1704164687"></script>
    <script src="/docs-uan/js/learn.js?1704164687"></script>
    <script src="/docs-uan/js/hugo-learn.js?1704164687"></script>
    
        
            <script src="/docs-uan/mermaid/mermaid.js?1704164687"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

